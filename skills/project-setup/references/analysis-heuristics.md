# Analysis Heuristics Reference

This document maps detected project signals to specific Claude Code configuration recommendations. Use these tables during Phase 1 analysis and Phase 2 report generation.

---

## 1. Hook Heuristics

Hooks automate formatting, linting, and safety checks. Each hook fires on a Claude Code tool event.

### PostToolUse Hooks (Auto-format/lint after file changes)

| Signal File(s) | File Glob Filter | Event | Matcher | Command | Notes |
|----------------|-----------------|-------|---------|---------|-------|
| `.prettierrc`, `.prettierrc.*`, `prettier.config.*` | `*.{js,jsx,ts,tsx,css,scss,html,json,md,yaml,yml}` | PostToolUse | `Write\|Edit` | `npx prettier --write $CLAUDE_FILE_PATHS` | Most common JS/TS formatter |
| `eslint.config.*`, `.eslintrc*` | `*.{js,jsx,ts,tsx}` | PostToolUse | `Write\|Edit` | `npx eslint --fix $CLAUDE_FILE_PATHS` | Pairs with Prettier; run after Prettier |
| `biome.json`, `biome.jsonc` | `*.{js,jsx,ts,tsx,json}` | PostToolUse | `Write\|Edit` | `npx biome check --write $CLAUDE_FILE_PATHS` | Alternative to Prettier+ESLint combo |
| `ruff.toml` OR `[tool.ruff]` in pyproject.toml | `*.py` | PostToolUse | `Write\|Edit` | `ruff check --fix $CLAUDE_FILE_PATHS && ruff format $CLAUDE_FILE_PATHS` | Fast Python linter+formatter |
| `[tool.black]` in pyproject.toml OR `black` in dev deps | `*.py` | PostToolUse | `Write\|Edit` | `black $CLAUDE_FILE_PATHS` | Python formatter (if ruff not present) |
| `.pylintrc`, `pylintrc` | `*.py` | PostToolUse | `Write\|Edit` | `pylint $CLAUDE_FILE_PATHS` | Python linter (advisory, may have many warnings) |
| `tsconfig.json` | `*.{ts,tsx}` | PostToolUse | `Write\|Edit` | `npx tsc --noEmit` | Type-check after TS changes; no glob filter needed since whole-project check |
| `go.mod` | `*.go` | PostToolUse | `Write\|Edit` | `gofmt -w $CLAUDE_FILE_PATHS` | Go always uses gofmt |
| `go.mod` + `goimports` in tools | `*.go` | PostToolUse | `Write\|Edit` | `goimports -w $CLAUDE_FILE_PATHS` | Preferred over gofmt if available |
| `Cargo.toml` | `*.rs` | PostToolUse | `Write\|Edit` | `rustfmt $CLAUDE_FILE_PATHS` | Rust formatter |
| `Cargo.toml` + `clippy` | `*.rs` | PostToolUse | `Write\|Edit` | `cargo clippy --fix --allow-dirty` | Rust linter; run less frequently |
| `.clang-format` | `*.{c,cpp,h,hpp,cc}` | PostToolUse | `Write\|Edit` | `clang-format -i $CLAUDE_FILE_PATHS` | C/C++ formatter |
| `Gemfile` + `rubocop` | `*.rb` | PostToolUse | `Write\|Edit` | `rubocop -A $CLAUDE_FILE_PATHS` | Ruby linter/formatter |
| `.php-cs-fixer.php` OR `phpcs.xml` | `*.php` | PostToolUse | `Write\|Edit` | `php-cs-fixer fix $CLAUDE_FILE_PATHS` | PHP formatter |
| `mix.exs` | `*.ex,*.exs` | PostToolUse | `Write\|Edit` | `mix format $CLAUDE_FILE_PATHS` | Elixir formatter |
| `dart` / `pubspec.yaml` | `*.dart` | PostToolUse | `Write\|Edit` | `dart format $CLAUDE_FILE_PATHS` | Dart formatter |

**Priority rule:** If both Prettier and Biome are detected, prefer Biome (it's meant to replace Prettier+ESLint). If both Black and Ruff are detected, prefer Ruff.

### PreToolUse Hooks (Safety guards)

| Signal | Event | Matcher | Command/Action | Rationale |
|--------|-------|---------|----------------|-----------|
| `.env*` files exist | PreToolUse | `Write\|Edit` | Block if file path matches `.env*` pattern | Prevent accidental secret exposure |
| Lock files (`package-lock.json`, `yarn.lock`, `pnpm-lock.yaml`, `Cargo.lock`, `poetry.lock`, `Gemfile.lock`, `composer.lock`) | PreToolUse | `Write\|Edit` | Block if file path matches lock file names | Lock files should only change via package manager |
| `migrations/` directory | PreToolUse | `Write\|Edit` | Block if file path is inside `migrations/` | Migrations should be generated by migration tools, not edited directly |
| `*.min.js`, `*.min.css`, `dist/`, `build/` | PreToolUse | `Write\|Edit` | Block if path matches build artifacts | Don't edit generated/minified files |

**Implementation note for PreToolUse hooks:** These use a bash script that checks `$CLAUDE_FILE_PATHS` against blocked patterns and exits with code 2 (block) if matched. The script should output a helpful message explaining why the edit was blocked.

### Notification Hooks

| Signal | Event | Matcher | Command | Rationale |
|--------|-------|---------|---------|-----------|
| Large codebase | Notification | `stop` | Desktop notification command | Alert user when long tasks complete |

---

## 2. Skill Heuristics

Skills provide reusable workflows invoked by users or automatically by Claude.

### User-Invocable Skills

| Signal | Skill Name | Invocation Name | Description | When to Recommend |
|--------|-----------|-----------------|-------------|-------------------|
| API routes directory (`routes/`, `api/`, `endpoints/`, `controllers/`) | api-doc | `/api-doc` | Generate or update API documentation from route definitions | API layer detected with 3+ route files |
| Database/ORM (`prisma/`, `alembic/`, `migrations/`, SQLAlchemy, TypeORM, Drizzle, Django models) | create-migration | `/create-migration` | Generate a database migration from schema changes | ORM or migration tool detected |
| Test framework configured (jest, vitest, pytest, go test, cargo test) | gen-test | `/gen-test` | Generate unit tests for a specified module or function | Test framework detected and test directory exists |
| React/Vue/Svelte/Angular component directory | new-component | `/new-component` | Scaffold a new UI component following project conventions | Frontend framework with components/ or similar directory |
| Git repository with tags or changelog | release-notes | `/release-notes` | Generate release notes from git log between two refs | Git repo with at least 10 commits |
| OpenAPI/Swagger spec (`openapi.yaml`, `swagger.json`) | api-client | `/api-client` | Generate or update API client code from OpenAPI spec | OpenAPI spec file detected |
| Docker/docker-compose files | docker-setup | `/docker-setup` | Generate or update Docker configuration | Dockerfile or docker-compose.yml exists |
| CI/CD configuration (`.github/workflows/`, `.gitlab-ci.yml`) | ci-update | `/ci-update` | Update CI/CD pipeline configuration | CI config detected |

### Auto-Invocable Skills (Claude uses automatically)

| Signal | Skill Name | Description | When to Recommend |
|--------|-----------|-------------|-------------------|
| Consistent coding patterns detected | project-conventions | Documents and enforces project coding conventions | Always recommend if coding patterns are detectable |

---

## 3. Subagent Heuristics

Subagents are specialized Claude instances for focused tasks.

| Signal | Agent Name | Agent File | Model | Tools | Description | When to Recommend |
|--------|-----------|------------|-------|-------|-------------|-------------------|
| Codebase >500 files | code-reviewer | `code-reviewer.md` | sonnet | Read, Grep, Glob | Reviews code changes for quality, patterns, and potential issues | Large codebases where review is valuable |
| Auth/security code detected (auth/, security/, login patterns) | security-reviewer | `security-reviewer.md` | sonnet | Read, Grep, Glob | Reviews changes for security vulnerabilities (OWASP Top 10, auth flaws) | Security-sensitive code detected |
| Frontend with component library | ui-reviewer | `ui-reviewer.md` | sonnet | Read, Grep, Glob | Reviews UI components for accessibility, consistency, and best practices | Frontend project with 10+ components |
| Test directory with <50% coverage or sparse tests | test-writer | `test-writer.md` | sonnet | Read, Write, Grep, Glob | Generates comprehensive tests for untested modules | Test framework exists but coverage appears low |
| Monorepo with 3+ packages | dependency-checker | `dependency-checker.md` | haiku | Read, Grep, Glob | Checks for dependency conflicts and version mismatches across packages | Monorepo detected |
| API routes + documentation | api-validator | `api-validator.md` | haiku | Read, Grep, Glob | Validates API changes against documentation and type contracts | API layer with docs or types |

### Agent Model Selection Guidelines

- **sonnet** — Use for agents that need deep reasoning: code review, security analysis, test writing
- **haiku** — Use for agents doing pattern matching / validation: dependency checking, API validation, simple checks

---

## 4. MCP Server Heuristics

MCP servers extend Claude Code's capabilities with external tool integrations.

| Signal | Server Name | Package/Command | Type | Config | When to Recommend |
|--------|------------|-----------------|------|--------|-------------------|
| Popular framework in deps (React, Next.js, Vue, Django, FastAPI, Express, etc.) | context7 | `npx -y @upstash/context7-mcp@latest` | stdio | `{}` | Any project using a well-known framework; provides up-to-date docs |
| Frontend app (React, Vue, Svelte, Angular, Next.js) | playwright | `npx -y @anthropic-ai/mcp-server-playwright@latest` | stdio | `{}` | Frontend projects that could benefit from browser testing/interaction |
| GitHub remote detected | github | `npx -y @anthropic-ai/mcp-server-github@latest` | stdio | Needs `GITHUB_TOKEN` env var | GitHub-hosted repos for PR/issue management |
| PostgreSQL in dependencies (pg, psycopg2, diesel with postgres feature) | postgres | `npx -y @anthropic-ai/mcp-server-postgres@latest` | stdio | Needs connection string | Projects using PostgreSQL |
| Supabase in dependencies or `supabase/` directory | supabase | `npx -y @anthropic-ai/mcp-server-supabase@latest` | stdio | Needs Supabase project config | Supabase-backed projects |
| Redis in dependencies (redis, ioredis) | redis | MCP server if available | stdio | Needs connection config | Projects using Redis |
| AWS services (aws-sdk, boto3) | aws | MCP server if available | stdio | Needs AWS credentials | Projects using AWS services |
| Sentry in dependencies | sentry | `npx -y @anthropic-ai/mcp-server-sentry@latest` | stdio | Needs Sentry auth token | Projects with Sentry error tracking |
| Filesystem-heavy operations | filesystem | `npx -y @anthropic-ai/mcp-server-filesystem@latest` | stdio | Needs allowed directories | Projects needing broad file access |

**Note:** Only recommend MCP servers that have well-known, stable packages. If unsure about a server's availability or stability, skip it and note it as an optional future addition.

---

## 5. CLAUDE.md Section Heuristics

Determine which sections to include in the generated CLAUDE.md based on signals.

| Signal | Section | Priority | Content Source |
|--------|---------|----------|----------------|
| Always | Project Overview | Required | Manifest name, description, detected framework |
| Build/run scripts in manifest | Build & Run Commands | Required | Extract from scripts in package.json, Makefile, Cargo.toml, etc. |
| Formatter/linter detected | Code Style | Required | Name the tools, link to configs |
| Test framework detected | Testing | Required | Test command, test directory, coverage command if available |
| Directory structure has clear patterns | Project Structure | Recommended | Map key directories and their purposes |
| Git repo | Version Control | Recommended | Branch strategy if detectable, commit conventions |
| `.env.example` or environment vars | Environment Setup | Recommended | Required env vars, setup steps |
| Docker/containers detected | Deployment | Optional | Docker commands, deployment notes |
| Auth/security patterns | Security Notes | Recommended | Auth approach, sensitive areas to be careful with |
| API layer detected | API Conventions | Optional | Endpoint patterns, response format, error handling |
| Multiple languages or workspaces | Monorepo Guide | Required (monorepo) | Workspace layout, cross-package dependencies |
| Agent SDK usage | Agent SDK Notes | Optional | Agent patterns, custom tool definitions |
| CI/CD detected | CI/CD | Optional | Pipeline structure, required checks |
| Package manager detected | Dependencies | Recommended | How to install, add, update dependencies |

### Priority Levels
- **Required** — Always include when signal is detected
- **Recommended** — Include unless CLAUDE.md would be excessively long
- **Optional** — Include only if project is well-structured and section adds clear value

---

## 6. Compound Signal Detection

Some recommendations depend on multiple signals:

| Compound Signal | Recommendation | Rationale |
|----------------|----------------|-----------|
| React + Storybook | Component skill + Storybook integration in CLAUDE.md | Component development workflow |
| TypeScript + strict mode | Type-check hook (high priority) | Strict TS means types matter |
| Python + Django + PostgreSQL | Migration skill + Postgres MCP + Django-specific CLAUDE.md | Full-stack Django setup |
| Next.js + Vercel | Deployment section in CLAUDE.md + Context7 MCP | Next.js-specific deployment |
| Monorepo + Turborepo/Nx | Workspace-aware hooks, dependency-checker agent | Monorepo-specific tooling |
| FastAPI + Pydantic | API doc skill + strict type-check notes | API-first Python setup |
| Go + protobuf | Proto generation notes in CLAUDE.md | gRPC workflow |

---

## 7. Scoring and Prioritization

When many recommendations are possible, prioritize by impact:

### High Priority (always recommend)
1. Formatter hooks (prevent style churn)
2. Safety guards (.env, lock files)
3. CLAUDE.md with build/test commands
4. Type-check hooks (TypeScript, Rust)

### Medium Priority (recommend for medium+ projects)
5. Linter hooks
6. Test generation skill
7. MCP servers for detected services
8. Code review agent (large projects)

### Low Priority (recommend for large/complex projects)
9. Specialized agents (security, UI)
10. Documentation skills
11. CI/CD skills
12. Notification hooks

If the total recommendation count exceeds 15 items, consider grouping lower-priority items as "optional additions" in the report.

---

## 8. Anti-Patterns to Avoid

Do NOT recommend:

1. **Duplicate formatters** — Don't recommend both Prettier and Biome, or both Black and Ruff
2. **Hooks for missing tools** — Don't recommend a rustfmt hook if the project doesn't have Rust files
3. **MCP servers needing credentials the user likely doesn't have** — Mark these as "requires setup" rather than auto-generating
4. **Skills for trivial tasks** — Don't create a skill for something that's a single command
5. **Agents for small codebases** — Code review agents add overhead for <100 file projects
6. **Conflicting hooks** — Don't have two hooks that format the same file type differently
7. **Platform-incompatible commands** — Always check platform before recommending shell-specific commands

---

## 9. Project-Type Template Matching

Templates provide curated, domain-specific configurations for well-known project types. They are stored as markdown files in `~/.claude/skills/project-setup/templates/`.

### Detection Fields

Each template defines detection criteria in its YAML frontmatter:

| Field | Type | How to Check |
|-------|------|-------------|
| `files_any` | list of glob patterns | At least one pattern matches a file in the project |
| `config_files_any` | list of file paths | At least one config file exists |
| `package_json_deps_any` | list of package names | At least one package is in dependencies or devDependencies |
| `python_deps_any` | list of package names | At least one package is in pyproject.toml deps or requirements.txt |

### Confidence Threshold

A template matches when **at least 2 detection field groups** are satisfied. Confidence is expressed as `N/M` where N is the number of matched groups and M is the total number of non-empty detection groups for that template.

| Matched Groups | Confidence | Action |
|---------------|------------|--------|
| 0–1 | Low | Do not include template items |
| 2 | Medium | Include template items, note as "medium confidence" |
| 3+ | High | Include template items, note as "high confidence" |

### Merge Priority Rules

When a template matches and its items overlap with heuristic-based recommendations:

| Item Type | Overlap Rule | Rationale |
|-----------|-------------|-----------|
| CLAUDE.md sections | Template section **replaces** generic section with same heading | Templates have domain-specific content that is more accurate |
| Hooks | Template hook **replaces** generic hook with same event + matcher | Templates know the right tool for the domain (e.g., theme-check vs generic linter) |
| Skills | **Additive** — both template and generic skills are included | Domain skills complement generic skills |
| Agents | **Additive** — both template and generic agents are included | Domain reviewers complement generic reviewers |
| MCP servers | Template server **replaces** generic server with same name | Templates may have better configuration for the domain |

### Item ID Convention

Template-sourced items use `[T]` prefix IDs in the Phase 2 report:

- `TC1`, `TC2`, ... — CLAUDE.md sections from template
- `TH1`, `TH2`, ... — Hooks from template
- `TS1`, `TS2`, ... — Skills from template
- `TA1`, `TA2`, ... — Agents from template
- `TM1`, `TM2`, ... — MCP servers from template

Users can skip or modify template items using these IDs, the same as any other recommendation.

---

## 10. External Skill Discovery Heuristics

External skills are community-authored Claude Code skills available via the `npx skills` CLI and the skills.sh registry. During Phase 1, discover relevant skills by mapping detected frameworks to search queries.

### Framework-to-Query Mapping

| Detected Framework | Search Queries |
|-------------------|----------------|
| React / Next.js | `react`, `nextjs` |
| Vue / Nuxt | `vue`, `nuxt` |
| Shopify | `shopify` |
| Python / FastAPI | `fastapi`, `python api` |
| Django | `django` |
| TypeScript | `typescript` |
| Tailwind | `tailwind` |
| Svelte / SvelteKit | `svelte` |
| Go / Gin / Echo | `golang` |
| Rust | `rust` |

### Discovery Rules

1. **Max 3 queries** — Select the most specific queries first (e.g., `fastapi` before `python api`). Stop after 3 queries to limit latency.
2. **Dedup by repository** — If the same repository appears in multiple query results, keep only one entry.
3. **Exclude overlaps with template skills** — If a template matched and has `external_skills`, skip any discovered skills that share the same repository + skill name.
4. **Limit to top 5** — After dedup and filtering, keep the 5 most relevant results (prefer higher install counts).
5. **Fall back on failure** — If `npx skills find` fails (timeout, npx unavailable, network error), use the template's `external_skills` list as the E# items in Phase 2.
6. **Source tagging** — Tag each E# item with its source: `[D]` for discovered via `npx skills find`, `[T]` for from the template's `external_skills` list.
7. **No blocking** — Discovery failures must not prevent the rest of Phase 1 from completing. Treat discovery as best-effort.
